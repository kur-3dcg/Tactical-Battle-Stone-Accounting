<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>戦術対抗戦石割収支集計ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="p-4 max-w-6xl mx-auto">
        <!-- ヘッダー -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-2">
                <h1 class="text-3xl font-bold text-indigo-700">戦術対抗戦石割収支集計ツール</h1>
                <div id="saveMessage" class="text-green-600 text-sm hidden">✓ 自動保存しました</div>
            </div>
            <div class="flex items-center justify-between">
                <p class="text-gray-600">最終順位から石の収支を自動計算</p>
                <div class="text-right">
                    <p class="text-sm text-gray-500">トータル収支</p>
                    <p id="totalBalance" class="text-3xl font-bold text-green-600">0個</p>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="exportCSV()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition text-sm">
                    📥 CSVエクスポート
                </button>
                <label class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition cursor-pointer text-sm">
                    📤 CSVインポート
                    <input type="file" accept=".csv" onchange="importCSV(event)" class="hidden">
                </label>
                <button onclick="recalculateAll()" class="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition text-sm">
                    🔄 データ再計算
                </button>
            </div>
        </div>

        <!-- データ入力フォーム -->
        <div id="inputForm" class="bg-white rounded-lg shadow-lg p-6 mb-6 transition-colors">
            <h2 id="formTitle" class="text-xl font-bold text-gray-800 mb-4">データ入力</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">日付</label>
                        <input type="date" id="dateInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最終順位</label>
                        <input type="number" id="rankInput" placeholder="順位を入力" min="1" max="15000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">割った石の数</label>
                        <input type="number" id="stonesInput" value="0" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div id="errorMessage" class="bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded hidden"></div>
                <div class="flex gap-2">
                    <button onclick="submitData()" class="flex items-center gap-2 bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition">
                        ➕ <span id="submitButtonText">追加</span>
                    </button>
                    <button id="cancelButton" onclick="cancelEdit()" class="bg-gray-400 text-white px-6 py-2 rounded-md hover:bg-gray-500 transition hidden">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>

        <!-- グラフ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">📈 収支推移グラフ</h2>
                <button onclick="toggleChart()" class="text-indigo-600 hover:text-indigo-700 font-medium">
                    <span id="chartToggleText">表示</span>
                </button>
            </div>
            <div id="chartContainer" class="hidden">
                <div class="mb-4 flex flex-wrap items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">基準日:</label>
                    <input type="date" id="chartBaseDate" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" onchange="updateChart()">
                    <button onclick="setToday()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm">最新</button>
                    <span class="text-gray-500 mx-2">|</span>
                    <label class="text-sm font-medium text-gray-700">期間:</label>
                </div>
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button onclick="setChartPeriod(7)" class="period-btn px-4 py-2 rounded-md bg-indigo-600 text-white">7日</button>
                    <button onclick="setChartPeriod(14)" class="period-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">14日</button>
                    <button onclick="setChartPeriod(30)" class="period-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">1ヶ月</button>
                    <button onclick="setChartPeriod(90)" class="period-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">3ヶ月</button>
                    <button onclick="setChartPeriod(180)" class="period-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">6ヶ月</button>
                </div>
                <canvas id="balanceChart" height="100"></canvas>
            </div>
        </div>

        <!-- データベーステーブル -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">データベース</h2>
                <div id="monthTabs" class="flex gap-2 flex-wrap"></div>
            </div>
            <div id="dataTable" class="overflow-x-auto"></div>
        </div>
    </div>

    <script>
        let data = [];
        let editingId = null;
        let lastRank = '';
        let selectedMonth = new Date().toISOString().slice(0, 7);
        let chartPeriod = 7;
        let chartBaseDate = new Date().toISOString().split('T')[0];
        let chartInstance = null;

        // 初期化
        document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
        document.getElementById('chartBaseDate').value = chartBaseDate;
        loadData();
        renderMonthTabs();
        renderTable();
        updateTotalBalance();

        function getRankReward(rank) {
            const r = parseInt(rank);
            if (r === 1) return 45;
            if (r === 2) return 40;
            if (r >= 3 && r <= 10) return 35;
            if (r >= 11 && r <= 100) return 30;
            if (r >= 101 && r <= 200) return 25;
            if (r >= 201 && r <= 500) return 20;
            if (r >= 501 && r <= 1000) return 18;
            if (r >= 1001 && r <= 2000) return 16;
            if (r >= 2001 && r <= 4000) return 14;
            if (r >= 4001 && r <= 8000) return 12;
            if (r >= 8001 && r <= 15000) return 10;
            return 0;
        }

        function loadData() {
            const saved = localStorage.getItem('pvpStoneData');
            const savedRank = localStorage.getItem('pvpLastRank');
            if (saved) {
                data = JSON.parse(saved);
            }
            if (savedRank) {
                lastRank = savedRank;
                document.getElementById('rankInput').placeholder = savedRank;
            }
        }

        function saveData() {
            localStorage.setItem('pvpStoneData', JSON.stringify(data));
            localStorage.setItem('pvpLastRank', lastRank);
            showSaveMessage();
        }

        function showSaveMessage() {
            const msg = document.getElementById('saveMessage');
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 2000);
        }

        function submitData() {
            const date = document.getElementById('dateInput').value;
            const rank = document.getElementById('rankInput').value;
            const stonesUsed = parseInt(document.getElementById('stonesInput').value) || 0;
            const errorDiv = document.getElementById('errorMessage');

            errorDiv.classList.add('hidden');

            if (!rank) {
                errorDiv.textContent = '順位を入力してください';
                errorDiv.classList.remove('hidden');
                return;
            }

            const existing = data.find(d => d.date === date && d.id !== editingId);
            if (existing) {
                errorDiv.textContent = '編集からデータを変更してください';
                errorDiv.classList.remove('hidden');
                return;
            }

            const reward = getRankReward(rank);
            const cost = stonesUsed * 60;
            const balance = reward - cost;

            if (editingId) {
                const index = data.findIndex(d => d.id === editingId);
                data[index] = { id: editingId, date, rank: parseInt(rank), stonesUsed, reward, cost, balance };
                editingId = null;
                document.getElementById('formTitle').textContent = 'データ入力';
                document.getElementById('submitButtonText').textContent = '追加';
                document.getElementById('cancelButton').classList.add('hidden');
                document.getElementById('inputForm').classList.remove('bg-yellow-50');
                document.getElementById('inputForm').classList.add('bg-white');
            } else {
                data.push({
                    id: Date.now(),
                    date,
                    rank: parseInt(rank),
                    stonesUsed,
                    reward,
                    cost,
                    balance
                });
            }

            data.sort((a, b) => new Date(a.date) - new Date(b.date));
            lastRank = rank;
            
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            document.getElementById('rankInput').value = rank;
            document.getElementById('stonesInput').value = 0;

            saveData();
            renderMonthTabs();
            renderTable();
            updateTotalBalance();
            updateChart();
        }

        function editData(id) {
            const entry = data.find(d => d.id === id);
            if (!entry) return;

            editingId = id;
            document.getElementById('dateInput').value = entry.date;
            document.getElementById('rankInput').value = entry.rank;
            document.getElementById('stonesInput').value = entry.stonesUsed;
            document.getElementById('formTitle').textContent = 'データ編集';
            document.getElementById('submitButtonText').textContent = '更新';
            document.getElementById('cancelButton').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('inputForm').classList.add('bg-yellow-50');
            document.getElementById('inputForm').classList.remove('bg-white');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteData(id) {
            if (!confirm('このデータを削除しますか？')) return;
            data = data.filter(d => d.id !== id);
            saveData();
            renderMonthTabs();
            renderTable();
            updateTotalBalance();
            updateChart();
        }

        function cancelEdit() {
            editingId = null;
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            document.getElementById('rankInput').value = lastRank;
            document.getElementById('stonesInput').value = 0;
            document.getElementById('formTitle').textContent = 'データ入力';
            document.getElementById('submitButtonText').textContent = '追加';
            document.getElementById('cancelButton').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('inputForm').classList.remove('bg-yellow-50');
            document.getElementById('inputForm').classList.add('bg-white');
        }

        function renderMonthTabs() {
            const months = [...new Set(data.map(d => d.date.slice(0, 7)))].sort().reverse();
            const tabsDiv = document.getElementById('monthTabs');
            
            if (months.length === 0) {
                tabsDiv.innerHTML = '';
                return;
            }

            if (!months.includes(selectedMonth)) {
                selectedMonth = months[0];
            }

            tabsDiv.innerHTML = months.map(month => {
                const date = new Date(month + '-01');
                const label = date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
                const active = month === selectedMonth;
                return `<button onclick="selectMonth('${month}')" class="px-4 py-2 rounded-md transition ${active ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">${label}</button>`;
            }).join('');
        }

        function selectMonth(month) {
            selectedMonth = month;
            renderMonthTabs();
            renderTable();
        }

        function renderTable() {
            const filtered = data.filter(d => d.date.startsWith(selectedMonth));
            const tableDiv = document.getElementById('dataTable');

            if (filtered.length === 0) {
                tableDiv.innerHTML = '<p class="text-gray-500 text-center py-8">データがありません</p>';
                return;
            }

            tableDiv.innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">日付</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">最終順位</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">報酬石</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">割った石</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">消費石</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">収支</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">操作</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${filtered.map(entry => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-900">${new Date(entry.date).toLocaleDateString('ja-JP')}</td>
                                <td class="px-4 py-3 text-sm text-gray-900">${entry.rank}位</td>
                                <td class="px-4 py-3 text-sm text-green-600 font-medium">+${entry.reward}個</td>
                                <td class="px-4 py-3 text-sm text-gray-900">${entry.stonesUsed}回</td>
                                <td class="px-4 py-3 text-sm text-red-600 font-medium">-${entry.cost}個</td>
                                <td class="px-4 py-3 text-sm font-bold ${entry.balance >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${entry.balance >= 0 ? '+' : ''}${entry.balance}個
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <button onclick="editData(${entry.id})" class="text-blue-600 hover:text-blue-800 mr-2">✏️</button>
                                    <button onclick="deleteData(${entry.id})" class="text-red-600 hover:text-red-800">🗑️</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateTotalBalance() {
            const total = data.reduce((sum, d) => sum + d.balance, 0);
            const elem = document.getElementById('totalBalance');
            elem.textContent = `${total >= 0 ? '+' : ''}${total}個`;
            elem.className = `text-3xl font-bold ${total >= 0 ? 'text-green-600' : 'text-red-600'}`;
        }

        function exportCSV() {
            if (data.length === 0) {
                alert('エクスポートするデータがありません');
                return;
            }

            const headers = ['日付', '最終順位', '報酬石', '割った石', '消費石', '収支'];
            const rows = data.map(d => [d.date, d.rank, d.reward, d.stonesUsed, d.cost, d.balance]);
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `戦術対抗戦データ_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const imported = [];

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const [date, rank, reward, stonesUsed, cost, balance] = line.split(',');
                        if (date && rank) {
                            imported.push({
                                id: Date.now() + i,
                                date: date.trim(),
                                rank: parseInt(rank) || 0,
                                stonesUsed: parseInt(stonesUsed) || 0,
                                reward: parseInt(reward) || 0,
                                cost: parseInt(cost) || 0,
                                balance: parseInt(balance) || 0
                            });
                        }
                    }

                    data = imported.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    // NaNがある場合は自動で再計算
                    const hasNaN = data.some(d => isNaN(d.reward) || isNaN(d.cost) || isNaN(d.balance) || d.reward === 0);
                    if (hasNaN) {
                        recalculateAll();
                        alert('CSVファイルを読み込み、データを再計算しました');
                    } else {
                        saveData();
                        renderMonthTabs();
                        renderTable();
                        updateTotalBalance();
                        updateChart();
                        showSaveMessage();
                    }
                } catch (err) {
                    alert('CSVファイルの読み込みに失敗しました');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function recalculateAll() {
            if (data.length === 0) {
                alert('再計算するデータがありません');
                return;
            }

            let recalculated = 0;
            data = data.map(entry => {
                const reward = getRankReward(entry.rank);
                const cost = entry.stonesUsed * 60;
                const balance = reward - cost;
                
                if (entry.reward !== reward || entry.cost !== cost || entry.balance !== balance) {
                    recalculated++;
                }
                
                return {
                    ...entry,
                    reward,
                    cost,
                    balance
                };
            });

            saveData();
            renderMonthTabs();
            renderTable();
            updateTotalBalance();
            updateChart();
            
            alert(`${recalculated}件のデータを再計算しました`);
        }

        function toggleChart() {
            const container = document.getElementById('chartContainer');
            const toggleText = document.getElementById('chartToggleText');
            const isHidden = container.classList.contains('hidden');
            
            if (isHidden) {
                container.classList.remove('hidden');
                toggleText.textContent = '非表示';
                updateChart();
            } else {
                container.classList.add('hidden');
                toggleText.textContent = '表示';
            }
        }

        function setToday() {
            chartBaseDate = new Date().toISOString().split('T')[0];
            document.getElementById('chartBaseDate').value = chartBaseDate;
            updateChart();
        }

        function setChartPeriod(days) {
            chartPeriod = days;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.className = 'period-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700';
            });
            event.target.className = 'period-btn px-4 py-2 rounded-md bg-indigo-600 text-white';
            updateChart();
        }

        function updateChart() {
            if (document.getElementById('chartContainer').classList.contains('hidden')) return;

            chartBaseDate = document.getElementById('chartBaseDate').value;
            const baseDate = new Date(chartBaseDate);
            const cutoff = new Date(baseDate);
            cutoff.setDate(cutoff.getDate() - chartPeriod);
            
            const filtered = data.filter(d => {
                const entryDate = new Date(d.date);
                return entryDate >= cutoff && entryDate <= baseDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            // 基準日以前の累計を計算
            const beforeData = data.filter(d => new Date(d.date) < cutoff).sort((a, b) => new Date(a.date) - new Date(b.date));
            let initialCumulative = beforeData.reduce((sum, d) => sum + d.balance, 0);

            let cumulative = initialCumulative;
            const chartData = filtered.map(d => {
                cumulative += d.balance;
                return {
                    date: new Date(d.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }),
                    balance: d.balance,
                    cumulative: cumulative
                };
            });

            const ctx = document.getElementById('balanceChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [{
                        label: '累計収支',
                        data: chartData.map(d => d.cumulative),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>